{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/Tools/multipass/nfs/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"1fed774f-3bab-54c5-95ae-e685fffe7289","excerpt":"Multipass の mount を sshfs から nfs へ変更 理由 ssh ログイン後 特定のディレクトリでレスポンスが悪い 。\n  などでも １分かかる場合がある。 ディレクトリのあるディレクトリでこの事象が起こる。 全てではない。 原因不明 ということで 以前の Vagrant + vmware…","html":"<h2>Multipass の mount を sshfs から nfs へ変更</h2>\n<p>理由</p>\n<ul>\n<li>\n<p>ssh ログイン後 特定のディレクトリでレスポンスが悪い 。\n<code class=\"language-text\">ls</code> <code class=\"language-text\">pwd</code> などでも １分かかる場合がある。</p>\n</li>\n<li>\n<p><code class=\"language-text\">.git</code>ディレクトリのあるディレクトリでこの事象が起こる。<br>\n全てではない。 原因不明</p>\n</li>\n</ul>\n<p>ということで 以前の Vagrant + vmware のレスポンスがほしいため mount の方法を変える。</p>\n<p>multipass デフォルトは sshfs で接続する。<br>\nmultipass の mount のコマンドは使わない。</p>\n<h3>振る舞い</h3>\n<h4>—cloud-init で nfs-common</h4>\n<p>これをインストールしないと nfs の mount ができない。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">packages:\n  - nfs-common</code></pre></div>\n<h4>作成された VM の IP から <code class=\"language-text\">/etc/exports/</code>へ追記</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> -i <span class=\"token string\">\"\"</span> <span class=\"token string\">\"/<span class=\"token variable\">${vm_ip}</span>/d\"</span> /etc/exports\n<span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"echo '<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> alldirs -mapall=<span class=\"token variable\">${USER_ID}</span>:<span class=\"token variable\">${GROUP_ID}</span>  <span class=\"token variable\">${vm_ip}</span>' >> /etc/exports\"</span></code></pre></div>\n<h4>multipass exec コマンドで mount ディレクトリ作成</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">multipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">mkdir</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span></code></pre></div>\n<h4>multipass exec コマンドで <code class=\"language-text\">/etc/fstab</code> へ追記、マウント</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">multipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"echo '<span class=\"token variable\">${NFS_HOST_IP}</span>:/<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span> nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0' >> /etc/fstab\"</span>\nmultipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"mount <span class=\"token variable\">${NFS_HOST_IP}</span>:/<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span>\"</span></code></pre></div>\n<h2>multipass vm 作成スクリプト</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###       cloud-config          ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token assign-left variable\">AUTHORIZED_KEYS_ID_RSA</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> <span class=\"token string\">\"<span class=\"token variable\">$RSA_PUB_FILE_NAME</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">AUTHORIZED_KEYS_ANSIBLE_RSA</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">cat</span> <span class=\"token string\">\"<span class=\"token variable\">$ANSIBLE_RSA_PUB_FILE_NAME</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span>./cloud-config.yaml <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">_EOF_\n---\nlocale: en_US.UTF8\ntimezone: Asia/Tokyo\npackages:\n  - nfs-common\nusers:\n  - name: ubuntu\n    ssh-authorized-keys:\n      - <span class=\"token variable\">${AUTHORIZED_KEYS_ID_RSA}</span>\n      - <span class=\"token variable\">${AUTHORIZED_KEYS_ANSIBLE_RSA}</span>\n_EOF_</span>\n<span class=\"token function\">cat</span> ./cloud-config.yaml\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###         Create VM           ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\nmultipass launch -c <span class=\"token string\">\"<span class=\"token variable\">${CPU}</span>\"</span> -m <span class=\"token string\">\"<span class=\"token variable\">${MEMORY}</span>\"</span> -d <span class=\"token string\">\"<span class=\"token variable\">${DISK_SIZE}</span>\"</span> -n <span class=\"token string\">\"<span class=\"token variable\">${VM_NAME}</span>\"</span> <span class=\"token string\">\"<span class=\"token variable\">${VM_VERSION}</span>\"</span> --cloud-init <span class=\"token string\">\"<span class=\"token variable\">${CLOUD_INIT}</span>\"</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">30</span>\n\n<span class=\"token comment\">#echo -e -n \"\\n\"</span>\n<span class=\"token comment\">#echo \"###################################\"</span>\n<span class=\"token comment\">#echo \"###        Mount Dir            ###\"</span>\n<span class=\"token comment\">#echo \"###################################\"</span>\n<span class=\"token comment\">#multipass mount \"${MOUNT_WORKSPACE_HOST}\" \"${VM_NAME}\":\"${MOUNT_WORKSPACE_VM}\"</span>\n<span class=\"token comment\">#echo \"mount ${MOUNT_WORKSPACE_HOST} ${VM_NAME}:${MOUNT_WORKSPACE_VM}\"</span>\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###      VM IP address          ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token assign-left variable\">vm_ip</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>multipass info develop <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> IPv4 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{ print $2 }'</span><span class=\"token variable\">)</span></span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"ipv4 : <span class=\"token variable\">${vm_ip}</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###  Create ansible inventory   ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span>./hosts/multipass <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">_EOF_\n[multipass]\nmultipass ansible_host=<span class=\"token variable\">$vm_ip</span> ansible_user=ubuntu ansible_ssh_private_key_file=<span class=\"token variable\">$RSA_FILE_NAME</span> ansible_ssh_common_args='-o StrictHostKeyChecking=no'\n\n[ubuntu20]\nmultipass\n_EOF_</span>\n<span class=\"token function\">cat</span> ./hosts/multipass\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n\n\n<span class=\"token builtin class-name\">echo</span> -e -n <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###           NFS               ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">sed</span> -i <span class=\"token string\">\"\"</span> <span class=\"token string\">\"/<span class=\"token variable\">${vm_ip}</span>/d\"</span> /etc/exports\n<span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"echo '<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> alldirs -mapall=<span class=\"token variable\">${USER_ID}</span>:<span class=\"token variable\">${GROUP_ID}</span>  <span class=\"token variable\">${vm_ip}</span>' >> /etc/exports\"</span>\nmultipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">mkdir</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span>\nmultipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"echo '<span class=\"token variable\">${NFS_HOST_IP}</span>:/<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span> nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0' >> /etc/fstab\"</span>\nmultipass <span class=\"token builtin class-name\">exec</span> <span class=\"token variable\">${VM_NAME}</span> -- <span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> -c <span class=\"token string\">\"mount <span class=\"token variable\">${NFS_HOST_IP}</span>:/<span class=\"token variable\">${MOUNT_WORKSPACE_HOST}</span> <span class=\"token variable\">${MOUNT_WORKSPACE_VM}</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###   Exec ansible playbook     ###\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"###################################\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$DEVELOP_INIT</span>\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$DEVELOP_INIT</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">'true'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n ansible-playbook -i hosts/multipass site.yml -l multipass\n<span class=\"token comment\"># ansible-playbook -i hosts/multipass site.yml -l multipass -t tests</span>\n<span class=\"token keyword\">else</span>\n ansible-playbook -i hosts/multipass site.yml -l multipass --skip-tags develop_init\n<span class=\"token keyword\">fi</span>\n</code></pre></div>\n<h2>sshfs から nfs に変更しての結果</h2>\n<p>上記の症状は全くなし。通常のターミナル操作もレスポンスが早くなった気がする。<br>\nデフォルトで <code class=\"language-text\">nfs</code> 接続だったらいいのに・・・</p>","frontmatter":{"title":"multipass nfs","date":"July 16, 2022","post_modified":"July 16, 2022","description":"multipassのディレクトリ共有をnfsに変更","tags":["multipass","Vagrant","ShellScript"],"draft":false}},"previous":{"fields":{"slug":"/Infrastructure/Iac/terraform/syntax/"},"frontmatter":{"title":"Terraform 構文"}},"next":null},"pageContext":{"id":"1fed774f-3bab-54c5-95ae-e685fffe7289","previousPostId":"c4354bba-b758-5a53-ba30-001e33faef72","nextPostId":null,"draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","1760060771","2772418575","3679674316"]}