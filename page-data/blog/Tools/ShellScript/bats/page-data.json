{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/Tools/ShellScript/bats/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"ef0d2b76-1bc5-5904-a36a-3c91c137d539","excerpt":"Bats でシェルスクリプトをテストする Install ubuntu Mac exec bats source test.bats Good pattern 結果 Bad pattern 結果 複数ファイルの実行 本来の シェルスクリプトを読み込んでテスト 構成 test.sh test.bats…","html":"<h2>Bats でシェルスクリプトをテストする</h2>\n<h3>Install</h3>\n<h4>ubuntu</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> bats</code></pre></div>\n<p>Mac</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">brew <span class=\"token function\">install</span> bats</code></pre></div>\n<h3>exec bats</h3>\n<p>source test.bats</p>\n<h4>Good pattern</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">@test <span class=\"token string\">'add test'</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token assign-left variable\">var_01</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>\n\t<span class=\"token assign-left variable\">var_02</span><span class=\"token operator\">=</span><span class=\"token number\">15</span>\n\t<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> var_01+var_02 -eq <span class=\"token number\">20</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n@test <span class=\"token string\">'div test'</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token assign-left variable\">var_01</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>\n\t<span class=\"token assign-left variable\">var_02</span><span class=\"token operator\">=</span><span class=\"token number\">15</span>\n\t<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> var_02/var_01 -eq <span class=\"token number\">3</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bats test.bats</code></pre></div>\n<p>結果</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">✓ <span class=\"token function\">add</span> <span class=\"token builtin class-name\">test</span>\n✓ div <span class=\"token builtin class-name\">test</span>\n\n<span class=\"token number\">2</span> tests, <span class=\"token number\">0</span> failures</code></pre></div>\n<h4>Bad pattern</h4>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">@test <span class=\"token string\">'add test'</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token assign-left variable\">var_01</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>\n\t<span class=\"token assign-left variable\">var_02</span><span class=\"token operator\">=</span><span class=\"token number\">15</span>\n\t<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> var_01+var_02 -eq <span class=\"token number\">20</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n@test <span class=\"token string\">'div test'</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token assign-left variable\">var_01</span><span class=\"token operator\">=</span><span class=\"token number\">5</span>\n\t<span class=\"token assign-left variable\">var_02</span><span class=\"token operator\">=</span><span class=\"token number\">15</span>\n\t<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> var_02/var_01 -eq <span class=\"token number\">2</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># Here</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bats test.bats</code></pre></div>\n<p>結果</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> ✓ <span class=\"token function\">add</span> <span class=\"token builtin class-name\">test</span>\n✗ div <span class=\"token builtin class-name\">test</span>\n  <span class=\"token punctuation\">(</span>in <span class=\"token builtin class-name\">test</span> <span class=\"token function\">file</span> test.bats, line <span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n    `<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> var_02/var_01 -eq <span class=\"token number\">2</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>' failed\n\n<span class=\"token number\">2</span> tests, <span class=\"token number\">1</span> failure</code></pre></div>\n<h3>複数ファイルの実行</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">├── tests\n│   ├── test.bats\n│   └── test2.bats\n</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">bats tests</code></pre></div>\n<h3>本来の シェルスクリプトを読み込んでテスト</h3>\n<p>構成</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">├── test.sh\n└── test.bats</code></pre></div>\n<p>test.sh</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$1</span> <span class=\"token operator\">==</span> <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n\t<span class=\"token assign-left variable\">param</span><span class=\"token operator\">=</span><span class=\"token string\">'test'</span>\n<span class=\"token keyword\">else</span>\n\t<span class=\"token assign-left variable\">param</span><span class=\"token operator\">=</span><span class=\"token string\">'not test'</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$param</span>\"</span>\n</code></pre></div>\n<p>test.bats</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">@test <span class=\"token string\">'param test ok'</span> <span class=\"token punctuation\">{</span>\n  run ./test.sh <span class=\"token builtin class-name\">test</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> -eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$output</span> <span class=\"token operator\">==</span> <span class=\"token string\">'test'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n@test <span class=\"token string\">'param test ng'</span> <span class=\"token punctuation\">{</span>\n  run ./test.sh tst\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> -eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$output</span> <span class=\"token operator\">==</span> <span class=\"token string\">'not test'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>テストスクリプトを別ディレクトリで管理したい</h3>\n<p>構成</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">├── test.sh\n└── tests\n    ├── test.bats</code></pre></div>\n<p>bats には bats を実行している絶対パスを BATS_TEST_DIRNAME という環境変数もっている。 でもこの場合は一つ上のディレクトリを指定したい</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${BATS_TEST_DIRNAME<span class=\"token operator\">%</span><span class=\"token operator\">/</span>*}</span>:<span class=\"token environment constant\">$PATH</span>\"</span></code></pre></div>\n<p><code class=\"language-text\">%/*</code>で一つ上のディレクトリを Path に追加</p>\n<p>test.sh</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$1</span> <span class=\"token operator\">==</span> <span class=\"token builtin class-name\">test</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n\t<span class=\"token assign-left variable\">param</span><span class=\"token operator\">=</span><span class=\"token string\">'test'</span>\n<span class=\"token keyword\">else</span>\n\t<span class=\"token assign-left variable\">param</span><span class=\"token operator\">=</span><span class=\"token string\">'not test'</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$param</span>\"</span>\n</code></pre></div>\n<p>tests/test.bats</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${BATS_TEST_DIRNAME<span class=\"token operator\">%</span><span class=\"token operator\">/</span>*}</span>:<span class=\"token environment constant\">$PATH</span>\"</span>\n\n@test <span class=\"token string\">'param test ok'</span> <span class=\"token punctuation\">{</span>\n  run test.sh <span class=\"token builtin class-name\">test</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> -eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$output</span> <span class=\"token operator\">==</span> <span class=\"token string\">'test'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n@test <span class=\"token string\">'param test ng'</span> <span class=\"token punctuation\">{</span>\n  run test.sh tst\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> -eq <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$output</span> <span class=\"token operator\">==</span> <span class=\"token string\">'not test'</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>run 後の変数</h3>\n<table>\n<thead>\n<tr>\n<th>変数</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>status</td>\n<td>終了ステータス</td>\n</tr>\n<tr>\n<td>output</td>\n<td>スクリプトの出力</td>\n</tr>\n<tr>\n<td>lines</td>\n<td>outputを分割した配列</td>\n</tr>\n</tbody>\n</table>\n<p>通常は status と output で判定</p>\n<p>c</p>","frontmatter":{"title":"シェルスクリプトをテストする","date":"April 05, 2022","post_modified":"April 05, 2022","description":"シェルスクリプトにテスト導入、コード品質の向上","tags":["ShellScript"],"draft":false}},"previous":{"fields":{"slug":"/Tools/ShellScript/debug/"},"frontmatter":{"title":"シェルスクリプトのデバッグでよく使われるOptionのデバッグ"}},"next":{"fields":{"slug":"/Infrastructure/Iac/terraform/syntax/"},"frontmatter":{"title":"Terraform 構文"}}},"pageContext":{"id":"ef0d2b76-1bc5-5904-a36a-3c91c137d539","previousPostId":"a5a0b2a3-32d2-5aeb-b783-fe2707579039","nextPostId":"c4354bba-b758-5a53-ba30-001e33faef72","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","1760060771","2772418575","3679674316"]}