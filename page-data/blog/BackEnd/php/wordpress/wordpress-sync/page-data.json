{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/BackEnd/php/wordpress/wordpress-sync/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"276d2295-9b2b-5c93-8163-ed8ed077d6d9","excerpt":"WordPress で Git を使った Webhook デプロイとリモート DB 同期 ここでのGitの使い方はあくまで”1 人_Git”、“オレオレ Git”なのでチームでの Git の使い方には参考にはなりません。 Git リポジトリーへ Push し自動デプロイはよくありますが Git…","html":"<h1>WordPress で Git を使った Webhook デプロイとリモート DB 同期</h1>\n<p>ここでの<strong>Git</strong>の使い方はあくまで”1 人_Git”、“オレオレ Git”なのでチームでの Git の使い方には参考にはなりません。</p>\n<p>Git リポジトリーへ Push し自動デプロイはよくありますが Git を利用して本番サーバーの\n<strong>DB をローカルへ同期</strong> するスクリプトを組んでみます。</p>\n<h2>よくある Webhook による自動デプロイ</h2>\n<h3>GitLab の Webhook をトリガーに”Git pull”し、Slack へ通知するスクリプト配置</h3>\n<p>サーバー上の任意の場所へ設置。</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token comment\">//Git deploy</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GIT_ROOT_DIR'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'../../'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Project root</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GIT_BRANCH'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'master'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// master , develop ....</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GIT_TOKEN'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'token'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// your token</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'GIT_TOKEN_NAME'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'X-Gitlab-Token'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$slack_urls</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// Slack URL</span>\n <span class=\"token string single-quoted-string\">'https://hooks.slack.com/services/xxxxxxxx/xxxxxxx/xxxxx'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$json_string</span> <span class=\"token operator\">=</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'php://input'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$json</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$json_string</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$header</span> <span class=\"token operator\">=</span> <span class=\"token function\">getallheaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//if ($header[GIT_TOKEN_NAME] !== GIT_TOKEN) {</span>\n<span class=\"token comment\">// echo 'exit';</span>\n<span class=\"token comment\">////    if(false) {</span>\n<span class=\"token comment\">// exit();</span>\n<span class=\"token comment\">//}</span>\n <span class=\"token variable\">$command</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"cd \"</span> <span class=\"token operator\">.</span> <span class=\"token constant\">GIT_ROOT_DIR</span> <span class=\"token operator\">.</span><span class=\"token string double-quoted-string\">\" &amp;&amp; git fetch origin master &amp;&amp; git reset --hard origin/\"</span><span class=\"token operator\">.</span><span class=\"token constant\">GIT_BRANCH</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$command</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$out</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$return_ver</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$slack_urls</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n <span class=\"token variable\">$result_mess</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">;</span>\n <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$return_ver</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Deploy Success</span>\n    <span class=\"token variable\">$emoji</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\":smile:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$color</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'good'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result_test</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"Deploy Sucess\"</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Deploy Failed</span>\n    <span class=\"token variable\">$emoji</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\":scream:\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$color</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'danger'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result_test</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"Deploy Failed\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$result_test</span> <span class=\"token operator\">.=</span> <span class=\"token string double-quoted-string\">\"   \"</span><span class=\"token operator\">.</span><span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"Y/m/d H:i:s\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$out</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$key</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token variable\">$result_mess</span> <span class=\"token operator\">.=</span> <span class=\"token variable\">$value</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"n\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span>\n <span class=\"token variable\">$payload</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'\n {\n \"username\": \"\",\n   \"attachments\":[\n      {\n         \"fallback\":\"Deploy\",\n         \"pretext\":\"Deploy '</span><span class=\"token operator\">.</span> <span class=\"token constant\">GIT_REPO</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">' '</span><span class=\"token operator\">.</span><span class=\"token constant\">GIT_BRANCH</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\",\n         \"color\":\"'</span><span class=\"token operator\">.</span><span class=\"token variable\">$color</span><span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\",\n         \"fields\":[\n            {\n               \"title\":\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$emoji</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$result_test</span> <span class=\"token operator\">.</span> <span class=\"token string single-quoted-string\">'\",\n               \"value\":\"'</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$result_mess</span> <span class=\"token operator\">.</span><span class=\"token string single-quoted-string\">'\"\n            }\n         ]\n      }\n   ]\n} '</span><span class=\"token punctuation\">;</span>\n\n <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$slack_urls</span> <span class=\"token keyword\">as</span> <span class=\"token variable\">$slack_url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$ch</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_URL</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$slack_url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_RETURNTRANSFER</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_POST</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">curl_setopt</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CURLOPT_POSTFIELDS</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$res</span> <span class=\"token operator\">=</span> <span class=\"token function\">curl_exec</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//  var_dump($res);</span>\n    <span class=\"token function\">curl_close</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ch</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></span></code></pre></div>\n<h3>GitLab のインテグレーション設定</h3>\n<p>GitLab->設定->インテグレーション</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c8cd79850e66f383be2c492741c11fae/8733b/gitlab-webhook.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.18987341772153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWUlEQVQoz42SW27bMBAAdf9j9L+nKZK6ViIrsCTTcqyY++Cb3ECWGwRygnY+F5gdEtjKGI4xllK6rlNKMbPzzjDT887Wjf3122+bNL6mTqV6FzdPmbiIlJxLKZUxJuecUkIEZgYA5z0T6odNeOnctvGbp1Dv4uEYp0scT8m5Wb5SAUAIIecsnzDW8HNr68YdlG1at6m9Bi8llBxiXLLXsjXlxm0kIoiozq9gDTlLzvlldylSpHyiYub8d9OHbKw5nU4ImpmZiBCdteWOChFXo6Xcdd04jloDIhJRCCGltJZX2UVmZqXU5XJhvrWNMd77tXz/GBEhov1+3w+91pqI9PwACDH8n8zUD706KgAABCICAO+9iPxbRsRhGGbxirEmpXT/we/LfX+ezhr0QkpplS0iX8vTNLVtOzvz7aUvsjHmN72Wl3Poh/7xz6Nz7n71fF4i+fzmf/x8B2Cx82YmG4IRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"gitlab webhook\"\n        title=\"gitlab webhook\"\n        src=\"/static/c8cd79850e66f383be2c492741c11fae/f058b/gitlab-webhook.png\"\n        srcset=\"/static/c8cd79850e66f383be2c492741c11fae/c26ae/gitlab-webhook.png 158w,\n/static/c8cd79850e66f383be2c492741c11fae/6bdcf/gitlab-webhook.png 315w,\n/static/c8cd79850e66f383be2c492741c11fae/f058b/gitlab-webhook.png 630w,\n/static/c8cd79850e66f383be2c492741c11fae/40601/gitlab-webhook.png 945w,\n/static/c8cd79850e66f383be2c492741c11fae/78612/gitlab-webhook.png 1260w,\n/static/c8cd79850e66f383be2c492741c11fae/8733b/gitlab-webhook.png 1495w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>“Git push”する度に自動デプロイされる。</p>\n<h2>リモートの MYSQL をローカルへ同期</h2>\n<h3>リモートに MySQL をバックアップし”git commit”,“git push”するスクリプトを設置</h3>\n<p>Git の管理内で公開ディレクトリでない場所に設置するのが望ましいかと思います。 実行権限も忘れずに。<br>\nmysql-sync.sh (仮)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/local/bin/bash</span>\n<span class=\"token assign-left variable\">SQLHOST</span><span class=\"token operator\">=</span> ホスト名\n<span class=\"token assign-left variable\">SQLUSER</span><span class=\"token operator\">=</span> ユーザー名\n<span class=\"token assign-left variable\">SQLPASSWORD</span><span class=\"token operator\">=</span> パスワード\n<span class=\"token assign-left variable\">SQLTARGETDB</span><span class=\"token operator\">=</span> DB名\n\n// ファイル名\n<span class=\"token assign-left variable\">SQL_FILE_NAME</span><span class=\"token operator\">=</span>db.sql\n// 圧縮後のファイル名\n<span class=\"token assign-left variable\">SQL_ZIP_FILE_NAME</span><span class=\"token operator\">=</span>data/db.zip\n// Zipパスワード\n<span class=\"token assign-left variable\">SQL_ZIP_PASS</span><span class=\"token operator\">=</span> パスワード\n\n// mysqldump のPath\n<span class=\"token assign-left variable\">MYSQLDUMP_PATH</span><span class=\"token operator\">=</span>/usr/local/bin/mysqldump\n\n// MySQLログインのためのテンポラリー my.cnf\n<span class=\"token assign-left variable\">MYCNF</span><span class=\"token operator\">=</span><span class=\"token variable\">${<span class=\"token environment constant\">HOME</span>}</span>/.my.cnf\n<span class=\"token function-name function\">MYCNFCREATE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">_EOL_<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> <span class=\"token variable\">${MYCNF}</span></span>\n[client]\nhost=<span class=\"token variable\">${SQLHOST}</span>\nuser=<span class=\"token variable\">${SQLUSER}</span>\npassword=\"<span class=\"token variable\">${SQLPASSWORD}</span>\"\n[mysqldump]\nhost=<span class=\"token variable\">${SQLHOST}</span>\nuser=<span class=\"token variable\">${SQLUSER}</span>\npassword=\"<span class=\"token variable\">${SQLPASSWORD}</span>\"\n_EOL_</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> -f <span class=\"token variable\">${MYCNF}</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">then</span>\n MYCNFCREATE\n<span class=\"token keyword\">else</span>\n <span class=\"token function\">mv</span> <span class=\"token variable\">${MYCNF}</span> <span class=\"token variable\">${MYCNF}</span>_<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%Y%m%d%H%M%S<span class=\"token variable\">)</span></span>\n MYCNFCREATE\n<span class=\"token keyword\">fi</span>\n\n// バックアップ\n<span class=\"token variable\">$MYSQLDUMP_PATH</span> <span class=\"token variable\">$SQLTARGETDB</span> <span class=\"token operator\">></span> <span class=\"token variable\">$SQL_FILE_NAME</span>\n// テンポラリー my.cnf 削除\n<span class=\"token function\">rm</span> -rf <span class=\"token variable\">${MYCNF}</span> <span class=\"token variable\">${MYCNF}</span>_<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%Y%m%d%H%M%S<span class=\"token variable\">)</span></span>\n\n// パスワード付きでZip圧縮\n<span class=\"token function\">zip</span> -e --password<span class=\"token operator\">=</span><span class=\"token variable\">$SQL_ZIP_PASS</span> <span class=\"token variable\">$SQL_ZIP_FILE_NAME</span> <span class=\"token variable\">$SQL_FILE_NAME</span>\n// sqlファイルは削除\n<span class=\"token function\">rm</span> -rf <span class=\"token variable\">$SQL_FILE_NAME</span>\n\n// Git pushまで\n<span class=\"token builtin class-name\">cd</span> <span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> -A\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">'Sync From Deploy'</span>\n<span class=\"token function\">git</span> push origin master</code></pre></div>\n<h3>MySQL 同期スクリプトをローカルに設置</h3>\n<p>SSH でのログインが必要です。鍵認証でのログインが設定済み前提です。(パスワード入力が[めんどくさい]{.under_line})</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># host別設定ファイル読み込み</span>\n<span class=\"token builtin class-name\">source</span> mysql.sync\n    <span class=\"token comment\"># sshにてlogin してmysqldumpを実行</span>\n    <span class=\"token function\">ssh</span> -p <span class=\"token variable\">$REMOTE_SSH_PORT</span> <span class=\"token variable\">$REMOTE_USER</span>@<span class=\"token variable\">$REMOTE_HOST</span> <span class=\"token variable\">$REMOTE_BACKUP_COMMAND</span>\n\n   <span class=\"token function\">git</span> pull origin master\n    <span class=\"token comment\"># パスワード付きzipファイル解凍</span>\n    <span class=\"token function\">unzip</span> -o -P <span class=\"token variable\">$ARCIVE_PASS</span> <span class=\"token variable\">$DOWNLOAD_FILE</span> -d <span class=\"token variable\">$AFTER_ARCIVE_DIR</span>\n\n    <span class=\"token comment\"># local MySQLログイン用ファイル読み込み</span>\n    <span class=\"token assign-left variable\">LOGIN_FILE</span><span class=\"token operator\">=</span>./local_mysql_login.cnf\n    <span class=\"token comment\"># local mysqlログイン及びdumpファイル実行</span>\n    mysql --defaults-extra-file<span class=\"token operator\">=</span><span class=\"token variable\">$LOGIN_FILE</span> <span class=\"token variable\">$LOCAL_DB_NAME</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$AFTER_ARCIVE_FILENAME</span>\n    <span class=\"token comment\"># local設定を反映させるSQL実行</span>\n    mysql --defaults-extra-file<span class=\"token operator\">=</span><span class=\"token variable\">$LOGIN_FILE</span> <span class=\"token operator\">&lt;</span> <span class=\"token variable\">$CHANGE_LOCAL_SQL_FILENAME</span>\n\n    <span class=\"token function\">rm</span> <span class=\"token variable\">$AFTER_ARCIVE_FILENAME</span>\n    <span class=\"token function\">rm</span> <span class=\"token variable\">$CHANGE_LOCAL_SQL_FILENAME</span></code></pre></div>\n<p>読み込んでいる mysql.sync</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># SSH ログイン情報</span>\n<span class=\"token assign-left variable\">REMOTE_HOST</span><span class=\"token operator\">=</span> ホスト名\nREMOTE_USER　ユーザー名\n<span class=\"token assign-left variable\">REMOTE_SSH_PORT</span><span class=\"token operator\">=</span> ポート番号\n\n<span class=\"token comment\"># Root ディレクトリ</span>\n<span class=\"token assign-left variable\">REMOTE_WP_ROOT</span><span class=\"token operator\">=</span>/home/xxx/www/xxxxx\n<span class=\"token comment\"># Remote backup path</span>\n<span class=\"token assign-left variable\">REMOTE_BACKUP_EXE_DIR</span><span class=\"token operator\">=</span><span class=\"token variable\">$REMOTE_WP_ROOT</span>/wp_sync/\n<span class=\"token comment\"># サーバー上に設定したスクリプトファイル名</span>\n<span class=\"token assign-left variable\">REMOTE_BACKUP_EXE</span><span class=\"token operator\">=</span> mysql-sync.sh <span class=\"token punctuation\">(</span>仮<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># バックアップコマンド実行</span>\n<span class=\"token assign-left variable\">REMOTE_BACKUP_COMMAND</span><span class=\"token operator\">=</span><span class=\"token string\">\"cd <span class=\"token variable\">$REMOTE_BACKUP_EXE_DIR</span>; ./<span class=\"token variable\">$REMOTE_BACKUP_EXE</span>\"</span>\n\n<span class=\"token comment\"># ローカル ディレウトリ</span>\n<span class=\"token assign-left variable\">LOCAL_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"/var/www/html/xxx/xxx\"</span>\n<span class=\"token assign-left variable\">DOWNLOAD_FILE</span><span class=\"token operator\">=</span><span class=\"token variable\">$LOCAL_PATH</span>/wp_sync/data/db.zip\n<span class=\"token assign-left variable\">ARCIVE_PASS</span><span class=\"token operator\">=</span> Zipパスワード\n<span class=\"token assign-left variable\">AFTER_ARCIVE_DIR</span><span class=\"token operator\">=</span><span class=\"token variable\">$LOCAL_PATH</span>/wp_sync/data\n<span class=\"token assign-left variable\">AFTER_ARCIVE_FILENAME</span><span class=\"token operator\">=</span><span class=\"token variable\">$AFTER_ARCIVE_DIR</span>/db.sql\n\n<span class=\"token comment\"># local db name</span>\n<span class=\"token assign-left variable\">LOCAL_DB_NAME</span><span class=\"token operator\">=</span> DB名\n\n<span class=\"token comment\"># 置換項目定数</span>\n<span class=\"token comment\">## Domain</span>\n<span class=\"token assign-left variable\">BEFORE_DOMAIN1</span><span class=\"token operator\">=</span><span class=\"token string\">\"Before domain\"</span>\n<span class=\"token assign-left variable\">AFTER_DOMAIN1</span><span class=\"token operator\">=</span><span class=\"token string\">\"After domain\"</span>\n\n<span class=\"token comment\">## Path</span>\n<span class=\"token assign-left variable\">BEFORE_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"Before Path\"</span>\n<span class=\"token assign-left variable\">AFTER_PATH</span><span class=\"token operator\">=</span><span class=\"token string\">\"After Path\"</span>\n<span class=\"token assign-left variable\">TABLE_PREFIX</span><span class=\"token operator\">=</span><span class=\"token string\">\"wp_\"</span>\n\n<span class=\"token comment\">## Update用のSQL生成</span>\n<span class=\"token assign-left variable\">CHANGE_LOCAL_SQL_FILENAME</span><span class=\"token operator\">=</span>change_local.sql\n<span class=\"token function\">touch</span> <span class=\"token variable\">$CHANGE_LOCAL_SQL_FILENAME</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span>EOF<span class=\"token operator\">></span> <span class=\"token variable\">$CHANGE_LOCAL_SQL_FILENAME</span>\nSET NAMES utf8<span class=\"token punctuation\">;</span>\nuse <span class=\"token variable\">${LOCAL_DB_NAME}</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>options <span class=\"token builtin class-name\">set</span>\noption_value <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>option_value,<span class=\"token string\">'${BEFORE_DOMAIN1}'</span>,<span class=\"token string\">'${AFTER_DOMAIN1}'</span><span class=\"token punctuation\">)</span>\nwhere option_value like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_DOMAIN1}</span>%\"</span><span class=\"token punctuation\">;</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>posts <span class=\"token builtin class-name\">set</span>\npost_content <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>post_content,<span class=\"token string\">'${BEFORE_DOMAIN1}'</span>,<span class=\"token string\">'${AFTER_DOMAIN1}'</span><span class=\"token punctuation\">)</span>\nwhere post_content like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_DOMAIN1}</span>%\"</span><span class=\"token punctuation\">;</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>posts <span class=\"token builtin class-name\">set</span>\npost_content_filtered <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>post_content_filtered,<span class=\"token string\">'${BEFORE_DOMAIN1}'</span>,<span class=\"token string\">'${AFTER_DOMAIN1}'</span><span class=\"token punctuation\">)</span>\nwhere post_content_filtered like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_DOMAIN1}</span>%\"</span><span class=\"token punctuation\">;</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>posts <span class=\"token builtin class-name\">set</span>\nguid <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>guid,<span class=\"token string\">'${BEFORE_DOMAIN1}'</span>,<span class=\"token string\">'${AFTER_DOMAIN1}'</span><span class=\"token punctuation\">)</span>\nwhere guid like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_DOMAIN1}</span>%\"</span><span class=\"token punctuation\">;</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>options <span class=\"token builtin class-name\">set</span>\noption_value <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>option_value, <span class=\"token string\">'${BEFORE_PATH}'</span>,<span class=\"token string\">'${AFTER_PATH}'</span><span class=\"token punctuation\">)</span>\nwhere option_value like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_PATH}</span>%\"</span><span class=\"token punctuation\">;</span>\n\nupdate <span class=\"token variable\">${TABLE_PREFIX}</span>postmeta <span class=\"token builtin class-name\">set</span>\nmeta_value <span class=\"token operator\">=</span> REPLACE<span class=\"token punctuation\">(</span>meta_value,<span class=\"token string\">'${BEFORE_DOMAIN1}'</span>,<span class=\"token string\">'${AFTER_DOMAIN1}'</span><span class=\"token punctuation\">)</span>\nwhere meta_value like <span class=\"token string\">\"%<span class=\"token variable\">${BEFORE_DOMAIN1}</span>%\"</span><span class=\"token punctuation\">;</span>\nEOF</code></pre></div>\n<p>読み込んでいる ローカル MySQL ログイン用 local_mysql_login.cnf</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>client<span class=\"token punctuation\">]</span>\nuser <span class=\"token operator\">=</span> root\npassword <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n<span class=\"token function\">host</span> <span class=\"token operator\">=</span> localhost</code></pre></div>\n<p>振る舞いとしては</p>\n<ol>\n<li>ローカルから SSH でサーバーへログイン</li>\n<li>サーバ側で MySQL バックアップ、“Git push”</li>\n<li>ローカルで”Git pull”</li>\n<li>Zip(sql ファイル、パスワード付き)を解凍</li>\n<li>ローカル MySQL へインポート</li>\n<li>変更必要箇所(ドメイン、Path) を Update 処理</li>\n</ol>\n<p>リモートの Database をローカルに同期するには手動でやると早くても数分はかかるでしょう。<br>\nまた手作業のためミスも起こる可能性も。<br>\nこのスクリプトでわずか数秒になりました。</p>\n<p>数分の[めんどくさい]{.under_line}を解消するために 1 日かけるという本末転倒かもしれないが共有することによりブラッシュアップされ無駄ではなくなると信じることにしてる。<br>\n自分のアイデアを形にすることはいい勉強にはなりますわね。</p>","frontmatter":{"title":"WordPressでGitを使ったWebhookデプロイとリモートDB同期","date":"September 23, 2019","post_modified":"September 23, 2019","description":"リモートのDBをローカルへ同期するめんどくさい作業をスクリプト化","tags":["MySQL","Wordpress","ShellScript"],"draft":false}},"previous":{"fields":{"slug":"/BackEnd/DB/MySQL/mysql57_first-login/"},"frontmatter":{"title":"MySQL5.7インストール後の初回ログイン"}},"next":{"fields":{"slug":"/Environment/vagrant-vmwear-network/"},"frontmatter":{"title":"Vagrant(VirtualBox)とVMwear Fusion をネットワーク共有"}}},"pageContext":{"id":"276d2295-9b2b-5c93-8163-ed8ed077d6d9","previousPostId":"4dae240e-d0ee-59cd-b6aa-b4e83162d764","nextPostId":"a5a440cc-ff6d-51c8-94fd-605002e0604e","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","1760060771","2772418575","3679674316"]}