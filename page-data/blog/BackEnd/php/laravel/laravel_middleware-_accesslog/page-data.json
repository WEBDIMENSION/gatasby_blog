{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/BackEnd/php/laravel/laravel_middleware-_accesslog/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"24887c3b-1c43-5ace-9eca-0274a1eb4a5e","excerpt":"laravel middleware で access 履歴 Model Middleware 登録 Models/Admin/AccessReport.php laravel/app/Http/Middleware/AccessReportMiddleware.php App/Http/Kernel.php…","html":"<h1>laravel middleware で access 履歴</h1>\n<h2>Model Middleware 登録</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">// Model 作成\nphp artisan make:model Models/Admin/AccessReport -m\n// Middleware 作成\nphp artisan make:middleware AccessReportMiddleware</code></pre></div>\n<h3>Models/Admin/AccessReport.php</h3>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Models<span class=\"token punctuation\">\\</span>Admin</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Database<span class=\"token punctuation\">\\</span>Eloquent<span class=\"token punctuation\">\\</span>Model</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AccessReport</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Model</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// カラム CREATED_AT を 'access_datetime'に変更</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">CREATED_AT</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'access_datetime'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">UPDATED_AT</span> <span class=\"token operator\">=</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Table名を'access_report'と指定</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$table</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'access_report'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// primary key を admin_id と指定</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$primaryKey</span> <span class=\"token operator\">=</span> <span class=\"token string single-quoted-string\">'admin_id'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/**\n     * The attributes that are mass assignable.\n     *\n     * @var array\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$fillable</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token comment\">// 変更許可カラム</span>\n        <span class=\"token string single-quoted-string\">'staff_id'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'execution_file'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'from_ipaddress'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'project_id'</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * The attributes that should be hidden for arrays.\n     *\n     * @var array\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$hidden</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>laravel/app/Http/Middleware/AccessReportMiddleware.php</h2>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Closure</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Models<span class=\"token punctuation\">\\</span>Admin<span class=\"token punctuation\">\\</span>AccessReport</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\"><span class=\"token punctuation\">\\</span>Route</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">AccessReportMiddleware</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * Handle an incoming request.\n     *\n     * @param  \\Illuminate\\Http\\Request  $request\n     * @param  \\Closure  $next\n     * @return mixed\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">Closure</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">accessReport</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//        return $next($request);</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">accessReport</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$status</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span> <span class=\"token operator\">-></span> <span class=\"token function\">user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$data</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n<span class=\"token comment\">//            'staff_id' => $user ? $user->id : 0,</span>\n            <span class=\"token string single-quoted-string\">'staff_id'</span> <span class=\"token operator\">=></span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'execution_file'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$request</span> <span class=\"token operator\">-></span> <span class=\"token function\">path</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// URIを格納</span>\n            <span class=\"token string single-quoted-string\">'from_ipaddress'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$request</span> <span class=\"token operator\">-></span> <span class=\"token function\">ip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//アクセス元IPを格納</span>\n            <span class=\"token string single-quoted-string\">'project_id'</span> <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name static-context\">AccessReport</span><span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>App/Http/Kernel.php</h2>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$routeMiddleware</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string single-quoted-string\">'auth'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Authenticate</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// Middleware へ 登録</span>\n        <span class=\"token string single-quoted-string\">'acr'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>AccessReportMiddleware</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'auth.basic'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>AuthenticateWithBasicAuth</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'bindings'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>SubstituteBindings</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'cache.headers'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>SetCacheHeaders</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'can'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Authorize</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'guest'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>RedirectIfAuthenticated</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'password.confirm'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>RequirePassword</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'signed'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ValidateSignature</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'throttle'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Routing<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>ThrottleRequests</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string single-quoted-string\">'verified'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>Illuminate<span class=\"token punctuation\">\\</span>Auth<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>EnsureEmailIsVerified</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>database/migrations/[DATETIME]_create_access_reports_table.php</h2>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Database<span class=\"token punctuation\">\\</span>Migrations<span class=\"token punctuation\">\\</span>Migration</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Database<span class=\"token punctuation\">\\</span>Schema<span class=\"token punctuation\">\\</span>Blueprint</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>Facades<span class=\"token punctuation\">\\</span>Schema</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name-definition class-name\">CreateAccessReportsTable</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Migration</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/**\n     * Run the migrations.\n     *\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">up</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name static-context\">Schema</span><span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'access_report'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Blueprint</span> <span class=\"token variable\">$table</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">bigIncrements</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'report_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">bigInteger</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'staff_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'execution_file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">char</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'from_ipaddress'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">dateTime</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'access_datetime'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token variable\">$table</span><span class=\"token operator\">-></span><span class=\"token function\">bigInteger</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'project_id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * Reverse the migrations.\n     *\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function-definition function\">down</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name static-context\">Schema</span><span class=\"token operator\">::</span><span class=\"token function\">dropIfExists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'access_report'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li></li>\n</ul>","frontmatter":{"title":"laravel middleware で access履歴","date":"December 15, 2020","post_modified":"December 15, 2020","description":"Laravel middleware を実践してみる","tags":["PHP","Laravel"],"draft":false}},"previous":{"fields":{"slug":"/Infrastructure/CICD/GitHub/github_actions/"},"frontmatter":{"title":"Github Actions 基本"}},"next":{"fields":{"slug":"/BackEnd/php/laravel/laravel_cache_clear/"},"frontmatter":{"title":"Laravel よく使うCache系のコマンド"}}},"pageContext":{"id":"24887c3b-1c43-5ace-9eca-0274a1eb4a5e","previousPostId":"3304de0a-ed7c-5568-ae1e-85ae55f20c15","nextPostId":"66ceb0b6-a536-5a80-868d-52c6c28f592f","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","1760060771","2772418575","3679674316"]}