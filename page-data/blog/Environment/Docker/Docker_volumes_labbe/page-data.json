{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/Environment/Docker/Docker_volumes_labbe/","result":{"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"6bc910ce-9ca2-546b-8e2c-92b77a3a4ccd","excerpt":"当ブログの Docker-compose.ynl ググれば host の node_modules と Containerの node_modules を同期させない情報はありそのまま使用してた。 ちなみに Dockerfile この状況だと 初回 (Container…","html":"<h2>当ブログの Docker-compose.ynl</h2>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> ./blog<span class=\"token punctuation\">:</span>/blog<span class=\"token punctuation\">:</span>delegated\n  <span class=\"token punctuation\">-</span> /blog/.cache\n  <span class=\"token punctuation\">-</span> /blog/build\n  <span class=\"token punctuation\">-</span> /node_modules\n  <span class=\"token punctuation\">-</span> /blog/public\n<span class=\"token punctuation\">...</span></code></pre></div>\n<p>ググれば host の node_modules と Containerの node_modules を同期させない情報はありそのまま使用してた。</p>\n<p>ちなみに Dockerfile</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:18</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install -g gatsby-cli@4.5.2</span>\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install -g npm</span></code></pre></div>\n<p>この状況だと</p>\n<p>初回 (Containerが生成されてない場合)</p>\n<p><code class=\"language-text\">docker-compose up -d</code></p>\n<p>で 立ち上げ</p>\n<p><code class=\"language-text\">docker-compse ecec xxx bash</code>\n<code class=\"language-text\">yarn install</code></p>\n<p>で node_modules を Install してから</p>\n<p><code class=\"language-text\">yarn start</code></p>\n<p>でサービス起動する。</p>\n<p>これだと</p>\n<p><code class=\"language-text\">docker-compose down</code></p>\n<p>をすると コンテナが消え次回</p>\n<p><code class=\"language-text\">docker-compose up -d</code></p>\n<p>して再度</p>\n<p><code class=\"language-text\">docker-compse ecec xxx bash</code>\n<code class=\"language-text\">yarn install</code></p>\n<p>しなければならない。時間のムダ。。。。</p>\n<h2>まずは Container 側の node_modules を volumes で永続化する</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">gatsby</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> gatsby\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./docker\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./blog<span class=\"token punctuation\">:</span>/blog<span class=\"token punctuation\">:</span>delegated\n      <span class=\"token comment\">#      - ../docker/package.json:/blog/package.json</span>\n      <span class=\"token punctuation\">-</span> /blog/.cache\n      <span class=\"token punctuation\">-</span> /blog/build\n      <span class=\"token punctuation\">-</span> node_volumes<span class=\"token punctuation\">:</span>/blog/node_modules\n      <span class=\"token punctuation\">-</span> /blog/public\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">node_volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gatsby_blog_node_volumes</code></pre></div>\n<p>これで 初回だけ</p>\n<p><code class=\"language-text\">docker-compse ecec xxx bash</code>\n<code class=\"language-text\">yarn install</code></p>\n<p>することにより node_modules は永続かされる。</p>\n<p>だが、</p>\n<p><code class=\"language-text\">eocker volume purge</code></p>\n<p>すればこの volume は削除される。</p>\n<h2>volumes に Label を付与、 purge から除外する</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">gatsby</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> gatsby\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./docker\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./blog<span class=\"token punctuation\">:</span>/blog<span class=\"token punctuation\">:</span>delegated\n      <span class=\"token comment\">#      - ../docker/package.json:/blog/package.json</span>\n      <span class=\"token punctuation\">-</span> /blog/.cache\n      <span class=\"token punctuation\">-</span> /blog/build\n      <span class=\"token punctuation\">-</span> node_volumes<span class=\"token punctuation\">:</span>/blog/node_modules\n      <span class=\"token punctuation\">-</span> /blog/public\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token punctuation\">...</span>\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">node_volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> gatsby_blog_node_volumes\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">keep</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<p>volumes を purge するときは</p>\n<p><code class=\"language-text\">docker volume prune --filter \"label!=keep\"'</code></p>\n<p>めんどいので <code class=\"language-text\">alias</code> を設定</p>\n<p><code class=\"language-text\">dvp='docker volume prune --filter \"label!=keep\"'</code></p>\n<p><code class=\"language-text\">dvp</code> を打つことにより 不要な volumes だけが削除されてさっぱり！。</p>\n<h2>docker-compose.yml に ‘yarn start’</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">gatsby</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> gatsby\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> ./docker\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./blog<span class=\"token punctuation\">:</span>/blog<span class=\"token punctuation\">:</span>delegated\n      <span class=\"token comment\">#      - ../docker/package.json:/blog/package.json</span>\n      <span class=\"token punctuation\">-</span> /blog/.cache\n      <span class=\"token punctuation\">-</span> /blog/build\n      <span class=\"token punctuation\">-</span> node_volumes<span class=\"token punctuation\">:</span>/blog/node_modules\n      <span class=\"token punctuation\">-</span> /blog/public\n    <span class=\"token key atrule\">working_dir</span><span class=\"token punctuation\">:</span> /blog\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token punctuation\">...</span>\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> gatsby develop <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>host 0.0.0.0</code></pre></div>\n<p>これで</p>\n<p><code class=\"language-text\">docker-compose up -d</code></p>\n<p>で サービスが起動する。らくちん。</p>\n<p>まぁ、</p>\n<p><code class=\"language-text\">gatsby develop --host 0.0.0.0</code></p>\n<p>なので ここは <code class=\"language-text\">develop mode</code> が起動するまでは多少時間がかかるが致し方ない。</p>\n<p>サービスの起動は <code class=\"language-text\">lazydocker</code> 等で確認</p>","frontmatter":{"title":"Docker volumes label","date":"March 10, 2023","post_modified":"March 10, 2023","description":"Docker volumes に Label をつけ永続化","tags":["Docker","Docker-compose","Node"],"draft":false}},"previous":{"fields":{"slug":"/Tools/uml/class/"},"frontmatter":{"title":"UML (クラス図)"}},"next":null},"pageContext":{"id":"6bc910ce-9ca2-546b-8e2c-92b77a3a4ccd","previousPostId":"84998945-a228-5947-8a91-4ead3e2d092f","nextPostId":null,"draft":false}},"staticQueryHashes":["1126706167","1176493165","1188992244","1314910092","1760060771","2772418575","3679674316"]}