{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/Infrastructure/Iac/ansible_vpn/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"e89b5584-c87f-58a7-b0fc-4c987b4b14af","excerpt":"VPN サーバー(SoftEhter)を Ansible で Conoha-VPN サーバーへ構築 GitHub inventory_file での host の指定を動的にしたい ローカルの Docker 上でのテスト, Act(GitHub actions…","html":"<h1>VPN サーバー(SoftEhter)を Ansible で Conoha-VPN サーバーへ構築</h1>\n<p><a href=\"https://github.com/WEBDIMENSION/ansible-softether-for-conoha\">GitHub</a></p>\n<h2>inventory_file での host の指定を動的にしたい</h2>\n<p>ローカルの Docker 上でのテスト, Act(GitHub actions のローカル版)を利用してのテスト、本番デプロイにおいて inventory_file での host の指定を動的にしたい。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">## vars-file for docker</span>\n<span class=\"token key atrule\">mount_dir</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'/softether'</span>\n<span class=\"token key atrule\">project_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Ansible-SoftEther-For-Conoha'</span>\n<span class=\"token key atrule\">docker_server</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host_ip</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"127.0.0.1\"</span>\n<span class=\"token key atrule\">ssh_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2223</span>\n<span class=\"token key atrule\">image_tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"softether_server\"</span>\n<span class=\"token key atrule\">container_tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"softether001\"</span>\n<span class=\"token key atrule\">container_ip</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n<span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"centos7\"</span>\n<span class=\"token key atrule\">inventory_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"docker_server\"</span>\n<span class=\"token key atrule\">docker_client</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">host_ip</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"127.0.0.1\"</span>\n<span class=\"token key atrule\">ssh_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2222</span>\n<span class=\"token key atrule\">image_tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"softether_client\"</span>\n<span class=\"token key atrule\">container_tag</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"softether_client\"</span>\n<span class=\"token key atrule\">container_ip</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n<span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ubuntu20.04\"</span>\n<span class=\"token key atrule\">inventory_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"docker_client\"</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Create inventory</span>\nhosts_text <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    cname <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    ip <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_ip\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    port <span class=\"token operator\">=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"ssh_port\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    hosts_text <span class=\"token operator\">+=</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>cname <span class=\"token operator\">+</span> <span class=\"token string\">\" ansible_host=\"</span> <span class=\"token operator\">+</span> ip<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"n\"</span>\nos<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span>pwd <span class=\"token operator\">+</span> <span class=\"token string\">\"/hosts\"</span><span class=\"token punctuation\">,</span> exist_ok<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>\n        pwd <span class=\"token operator\">+</span> <span class=\"token string\">\"/hosts/\"</span> <span class=\"token operator\">+</span> docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"inventory_name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"_root\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"w\"</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>SOFTETHER_INVENTORY_FILE<span class=\"token punctuation\">)</span>\nSOFTETHER_INVENTORY_FILE <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    textwrap<span class=\"token punctuation\">.</span>dedent<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n[softether]\n{hosts}\n[softether:vars]\nansible_user={ansible_user}\nansible_port={ansible_ssh_port}\nansible_ssh_private_key_file={mount_dir}/roles/ansible_user/{key}\\\n\"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n        hosts<span class=\"token operator\">=</span>hosts_text<span class=\"token punctuation\">,</span>\n        ansible_user<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_ansible_user<span class=\"token punctuation\">[</span><span class=\"token string\">\"ansible_users\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        ansible_ssh_port<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_sshd<span class=\"token punctuation\">[</span><span class=\"token string\">\"sshd_port\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        mount_dir<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        key<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_ansible_user<span class=\"token punctuation\">[</span><span class=\"token string\">\"ansible_users\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"secret_key\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\nos<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span>pwd <span class=\"token operator\">+</span> <span class=\"token string\">\"/hosts\"</span><span class=\"token punctuation\">,</span> exist_ok<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>\n        pwd <span class=\"token operator\">+</span> <span class=\"token string\">\"/hosts/\"</span> <span class=\"token operator\">+</span> docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"inventory_name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"_user\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"w\"</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>SOFTETHER_INVENTORY_FILE<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>nofity 設定反映するため Service を restart させる</h2>\n<p>Case in Firewalled</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># roles/firewalled/handlers/main.yml</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Restart\n  firewalld\n<span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n<span class=\"token key atrule\">systemd</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> restarted\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> firewalld\n<span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> yes</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Open\n  port\n  by\n  firewalld\n<span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n<span class=\"token key atrule\">firewalld</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.port }}\"</span>\n<span class=\"token key atrule\">permanent</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.permanent }}\"</span>\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.state }}\"</span>\n<span class=\"token key atrule\">with_items</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ firewalld_ports }}\"</span>\n<span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> firewalld_ports is defined\n<span class=\"token key atrule\">notify</span><span class=\"token punctuation\">:</span> Restart\n  firewalld  <span class=\"token comment\"># &lt;-  最終的にリスタートさせる</span></code></pre></div>\n<h2>Use dict for vars and loop</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">#  dict で書くことにより</span>\n<span class=\"token key atrule\">ansible_users</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">master</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ansible'</span>\n<span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'wheel'</span>\n<span class=\"token key atrule\">append</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'yes'</span>\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'present'</span>\n<span class=\"token key atrule\">remove</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'no'</span>\n<span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ secret.ansible_user_password }}\"</span>\n<span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"files/ansible_rsa.pub\"</span>\n<span class=\"token key atrule\">secret_key</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"files/ansible_rsa\"</span>\n<span class=\"token key atrule\">login_shell</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'/bin/bash'</span>\n<span class=\"token key atrule\">create_home</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'yes'</span>\n<span class=\"token key atrule\">sudo</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'present'</span>\n<span class=\"token key atrule\">comment</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'ansible user'</span>\n<span class=\"token key atrule\">expires</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'-1'</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#  指定しやすくなる</span>\n<span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>\n    hosts<span class=\"token operator\">=</span>hosts_text<span class=\"token punctuation\">,</span>\n    ansible_user<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_ansible_user<span class=\"token punctuation\">[</span><span class=\"token string\">\"ansible_users\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    ansible_ssh_port<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_sshd<span class=\"token punctuation\">[</span><span class=\"token string\">\"sshd_port\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    mount_dir<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>vars_ansible_user<span class=\"token punctuation\">[</span><span class=\"token string\">\"ansible_users\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"secret_key\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># playbook では with_dict を使い item.value.xxxになる</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> user <span class=\"token punctuation\">-</span> control\n<span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n<span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.name }}\"</span>\n<span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.groups }}\"</span>\n<span class=\"token key atrule\">state</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.state }}\"</span>\n<span class=\"token key atrule\">remove</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.remove }}\"</span>\n<span class=\"token key atrule\">create_home</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.create_home }}\"</span>\n<span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.password | password_hash('sha512') }}\"</span>\n<span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.login_shell }}\"</span>\n<span class=\"token key atrule\">comment</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.comment }}\"</span>\n<span class=\"token key atrule\">expires</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ item.value.expires }}\"</span>\n<span class=\"token key atrule\">with_dict</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"{{ ansible_users }}\"</span></code></pre></div>\n<h2>ansible-lint shell command</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Default command</span>\nansible-lint site.yml</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># docker execから ansible-lint</span>\nsubprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"docker exec -it \"</span>\n    <span class=\"token operator\">+</span> docker_client<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" bash -c 'cd \"</span>\n    <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" &amp;&amp; ansible-lint site.yml'\"</span><span class=\"token punctuation\">,</span>\n    shell<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    check<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>flake8</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Default command</span>\nflake8 <span class=\"token punctuation\">[</span>DIR_NAME FILE_NAME<span class=\"token punctuation\">]</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># docker execから flake8</span>\nsubprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"docker exec -it \"</span>\n    <span class=\"token operator\">+</span> docker_client<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" bash -c 'cd \"</span>\n    <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" &amp;&amp; flake8 tests tests.py deploy deploy.py'\"</span><span class=\"token punctuation\">,</span>\n    shell<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    check<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>block</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># default command</span>\nblack <span class=\"token punctuation\">[</span>DIR_NAME FILE_NAME<span class=\"token punctuation\">]</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># docker execから flake8</span>\nsubprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"docker exec -it \"</span>\n    <span class=\"token operator\">+</span> docker_client<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" bash -c 'cd \"</span>\n    <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" &amp;&amp; block tests tests.py deploy deploy.py'\"</span><span class=\"token punctuation\">,</span>\n    shell<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    check<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h2>testinfra for ansible</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">        subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"docker exec -it \"</span>\n    <span class=\"token operator\">+</span> docker_client<span class=\"token punctuation\">[</span><span class=\"token string\">\"hosts\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"container_tag\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">' bash -c \"cd '</span>\n    <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>vars_docker<span class=\"token punctuation\">[</span><span class=\"token string\">\"mount_dir\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" &amp;&amp; py.test -v tests/testinfra.py\"</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" --connection=ssh\"</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" --hosts='ansible://softether'\"</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\" --ansible-inventory='hosts/\"</span>\n    <span class=\"token operator\">+</span> docker_server<span class=\"token punctuation\">[</span><span class=\"token string\">\"inventory_name\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">+</span> <span class=\"token string\">\"_user'\"</span>\"<span class=\"token punctuation\">,</span>\nshell <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n        check <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Service check</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">test_sshd_running_and_enabled</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Check service sshd  \"\"\"</span>\n    service <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>service<span class=\"token punctuation\">(</span><span class=\"token string\">\"sshd\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">assert</span> service<span class=\"token punctuation\">.</span>is_running\n    <span class=\"token keyword\">assert</span> service<span class=\"token punctuation\">.</span>is_enabled\n\n\n<span class=\"token comment\"># Port check</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">test_open_port</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Check ports  \"\"\"</span>\n    all_variables <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>ansible<span class=\"token punctuation\">.</span>get_variables<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    localhost <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>addr<span class=\"token punctuation\">(</span><span class=\"token string\">\"localhost\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># sshd</span>\n    <span class=\"token keyword\">assert</span> localhost<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">(</span>all_variables<span class=\"token punctuation\">[</span><span class=\"token string\">\"sshd_port\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>is_reachable\n    <span class=\"token keyword\">if</span> all_variables<span class=\"token punctuation\">[</span><span class=\"token string\">\"sshd_port\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">22</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">assert</span> <span class=\"token keyword\">not</span> localhost<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">(</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>is_reachable\n    <span class=\"token comment\"># vpnserver</span>\n    <span class=\"token keyword\">assert</span> localhost<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">(</span><span class=\"token number\">443</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>is_reachable\n    <span class=\"token keyword\">assert</span> localhost<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">(</span><span class=\"token number\">5555</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>is_reachable\n    <span class=\"token keyword\">assert</span> localhost<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">(</span><span class=\"token number\">1194</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>is_reachable\n\n\n<span class=\"token comment\"># user check</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">test_ansible_user</span><span class=\"token punctuation\">(</span>host<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\" Check exists ansible user  \"\"\"</span>\n    all_variables <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>ansible<span class=\"token punctuation\">.</span>get_variables<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> all_variables<span class=\"token punctuation\">[</span><span class=\"token string\">\"ansible_users\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user <span class=\"token operator\">=</span> host<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">assert</span> user<span class=\"token punctuation\">.</span>exists\n        <span class=\"token keyword\">assert</span> user<span class=\"token punctuation\">.</span>name <span class=\"token operator\">==</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">assert</span> user<span class=\"token punctuation\">.</span>shell <span class=\"token operator\">==</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">\"login_shell\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">assert</span> user<span class=\"token punctuation\">.</span>home <span class=\"token operator\">==</span> <span class=\"token string\">\"/home/\"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Docker for Ansible test</h2>\n<p>Enable ssh systemd</p>\n<h3>CentOS7</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">FROM centos:centos7\nVOLUME <span class=\"token punctuation\">[</span> <span class=\"token string\">\"/sys/fs/cgroup\"</span> <span class=\"token punctuation\">]</span>\nRUN yum -y update<span class=\"token punctuation\">;</span> yum clean all\nRUN yum -y <span class=\"token function\">install</span> openssh-server <span class=\"token function\">passwd</span><span class=\"token punctuation\">;</span> yum clean all\nRUN yum <span class=\"token function\">install</span> -y <span class=\"token function\">which</span>\nRUN yum <span class=\"token function\">install</span> -y https://repo.ius.io/ius-release-el7.rpm\nRUN yum <span class=\"token function\">install</span> -y <span class=\"token function\">sudo</span>\nRUN yum <span class=\"token function\">install</span> -y <span class=\"token function\">wget</span>\nRUN yum <span class=\"token function\">install</span> -y <span class=\"token function\">curl</span>\nRUN yum <span class=\"token function\">install</span> -y sshpass\nRUN <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'root:password'</span> <span class=\"token operator\">|</span> chpasswd\nRUN <span class=\"token function\">mkdir</span> /root/.ssh\nRUN <span class=\"token function\">touch</span> /root/.ssh/config\nRUN <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">$'Host *<span class=\"token entity\" title=\"\\n\">\\n</span>\\\n <span class=\"token entity\" title=\"\\t\">\\t</span>StrictHostKeyChecking no<span class=\"token entity\" title=\"\\n\">\\n</span>\\\n <span class=\"token entity\" title=\"\\n\">\\n</span>\\\nServerAliveInterval 60 <span class=\"token entity\" title=\"\\n\">\\n</span>\\\nServerAliveCountMax 10 <span class=\"token entity\" title=\"\\n\">\\n</span> '</span>  <span class=\"token operator\">>></span> /root/.ssh/config\n\nRUN <span class=\"token function\">chmod</span> <span class=\"token number\">700</span> /root/.ssh/\nRUN <span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /root/.ssh/*\n\nRUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key -N <span class=\"token string\">''</span>\nENTRYPOINT <span class=\"token punctuation\">[</span><span class=\"token string\">\"/sbin/init\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h3>Ubuntu20.04</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">FROM ubuntu:20.04\nRUN <span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y software-properties-common <span class=\"token punctuation\">\\</span>\n                       tzdata\n\nRUN apt-add-repository -y ppa:git-core/ppa <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token function\">apt-get</span> update <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span>\n    <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> -y <span class=\"token function\">git</span> <span class=\"token punctuation\">\\</span>\n                       <span class=\"token function\">curl</span> <span class=\"token punctuation\">\\</span>\n                       openssh-server <span class=\"token punctuation\">\\</span>\n                       <span class=\"token function\">vim</span> <span class=\"token punctuation\">\\</span>\n                       <span class=\"token function\">sudo</span> <span class=\"token punctuation\">\\</span>\n                       sshpass <span class=\"token punctuation\">\\</span>\n                       python3-pip\nRUN <span class=\"token function\">mkdir</span> /root/.ssh\nRUN <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'\\n\\\nHost *\\n\\\n    StrictHostKeyChecking no\\n\\\n'</span> <span class=\"token operator\">>></span> /root/.ssh/config\n\nRUN <span class=\"token function\">chmod</span> <span class=\"token number\">700</span> /root/.ssh\nRUN <span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /root/.ssh/*\n\nRUN <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'root:root'</span> <span class=\"token operator\">|</span> chpasswd\nEXPOSE <span class=\"token number\">22</span>\nCMD <span class=\"token punctuation\">[</span> <span class=\"token string\">\"/sbin/init\"</span> <span class=\"token punctuation\">]</span></code></pre></div>","frontmatter":{"title":"VPNサーバー(SoftEhter)をAnsibleでConoha-VPNサーバーへ構築","date":"December 14, 2020","post_modified":"December 14, 2020","description":"Conoha API を使いVPN構築を簡略化 の備忘録","tags":["Linux","Docker","Python","Ansible","Testinfra","VPN"],"draft":false}},"previous":{"fields":{"slug":"/Environment/gh_ubuntu_on_mac/"},"frontmatter":{"title":"Ubuntu On Mac"}},"next":{"fields":{"slug":"/BackEnd/php/laravel/laravel_circleci/"},"frontmatter":{"title":"Laravel, CircleCI"}}},"pageContext":{"id":"e89b5584-c87f-58a7-b0fc-4c987b4b14af","previousPostId":"d5dc9519-6486-5d04-84bd-77d4327cee65","nextPostId":"2f99a5fa-8448-5c7d-9a85-461ce61c2578","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","2772418575"]}