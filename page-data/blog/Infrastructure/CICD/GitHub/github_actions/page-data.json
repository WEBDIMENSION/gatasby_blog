{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/Infrastructure/CICD/GitHub/github_actions/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"7500472b-2e7a-5952-a48f-d109973b87e2","excerpt":"Github Actions 基本 GitHub Actions Project top dir に .github/workflows を作る workflow ファイルを作成 *参照 VPN サーバー(SoftEhter)を Ansible で Conoha-VPN サーバーへ構築 Matirx ACT…","html":"<h1>Github Actions 基本</h1>\n<h2>GitHub Actions</h2>\n<p>Project top dir に .github/workflows を作る</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> -p .github/workflows</code></pre></div>\n<p>workflow ファイルを作成</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vim</span> tests.yml</code></pre></div>\n<p>*参照<br>\n<a href=\"https://github.com/WEBDIMENSION/ansible-softether-for-conoha\">VPN サーバー(SoftEhter)を Ansible で Conoha-VPN サーバーへ構築</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> softeher_tests\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> develop <span class=\"token punctuation\">]</span> <span class=\"token comment\"># Branch:develop へpush時に実行</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> master <span class=\"token punctuation\">]</span> <span class=\"token comment\"># Branch:maser へプルリクエスト時に実行</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span><span class=\"token number\">1804</span> <span class=\"token comment\"># Ubuntu18.04イメージを使用</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> docker server start\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -f dockerfiles/centos7/Dockerfile . -t softether_server\n          docker run -itd --privileged --name softether_server softether_server\n          sleep 5\n          container_ip=$(docker inspect --format \"{{ .NetworkSettings.IPAddress }}\" softether_server)\n          echo \"server ip :  $container_ip\"\n          echo \"\n          [softether]\n          $container_ip\n          [softether:vars]\n          ansible_user=root\n          ansible_ssh_pass=password\n          \" >> hosts/act_root</span>\n\n          echo \"\n          <span class=\"token punctuation\">[</span>softether<span class=\"token punctuation\">]</span>\n          $container_ip\n          <span class=\"token punctuation\">[</span>softether<span class=\"token punctuation\">:</span>vars<span class=\"token punctuation\">]</span>\n          ansible_user=ansible\n          ansible_port=50022\n          ansible_ssh_private_key_file=roles/ansible_user/files/ansible_rsa\n          \" <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> hosts/act_user\n\n          ls <span class=\"token punctuation\">-</span>ls hosts/*\n\n          mkdir /github/home/.ssh\n          chmod 700 /github/home/.ssh\n          echo \"Host *\n                StrictHostKeyChecking no\n\n          ServerAliveInterval 60\n          ServerAliveCountMax 10\"  <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> /github/home/.ssh/config\n\n          chmod 600 /github/home/.ssh/config\n          cat /github/home/.ssh/config\n\n          apt <span class=\"token punctuation\">-</span>y install make build<span class=\"token punctuation\">-</span>essential libssl<span class=\"token punctuation\">-</span>dev zlib1g<span class=\"token punctuation\">-</span>dev libbz2<span class=\"token punctuation\">-</span>dev \\\n          libreadline<span class=\"token punctuation\">-</span>dev libsqlite3<span class=\"token punctuation\">-</span>dev wget curl llvm libncurses5<span class=\"token punctuation\">-</span>dev libncursesw5<span class=\"token punctuation\">-</span>dev \\\n          xz<span class=\"token punctuation\">-</span>utils tk<span class=\"token punctuation\">-</span>dev libffi<span class=\"token punctuation\">-</span>dev liblzma<span class=\"token punctuation\">-</span>dev\n\n          curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/pyenv/pyenv<span class=\"token punctuation\">-</span>installer/raw/master/bin/pyenv<span class=\"token punctuation\">-</span>installer <span class=\"token punctuation\">|</span> bash\n          export PATH=\"/github/home/.pyenv/bin<span class=\"token punctuation\">:</span>$PATH\"\n          pyenv install 3.6.7\n          pyenv global 3.6.7\n          /github/home/.pyenv/shims/pip install <span class=\"token punctuation\">-</span>r requirements.txt\n\n          /github/home/.pyenv/shims/ansible<span class=\"token punctuation\">-</span>lint site.yml\n          /github/home/.pyenv/shims/black tests tests.py deploy deploy.py\n          /github/home/.pyenv/shims/flake8 tests tests.py deploy deploy.py\n\n          echo 'password' <span class=\"token punctuation\">></span><span class=\"token punctuation\">></span> vaultpass\n          /github/home/.pyenv/shims/ansible<span class=\"token punctuation\">-</span>playbook site.yml <span class=\"token punctuation\">-</span>i hosts/act_root <span class=\"token punctuation\">-</span>t softether\n          /github/home/.pyenv/shims/ansible<span class=\"token punctuation\">-</span>playbook site.yml <span class=\"token punctuation\">-</span>i hosts/act_user <span class=\"token punctuation\">-</span>t tools\n\n          /github/home/.pyenv/shims/py.test <span class=\"token punctuation\">-</span>v tests/testinfra.py \\\n          <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>connection=ssh \\\n          <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>hosts='ansible<span class=\"token punctuation\">:</span>//softether' \\\n          <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>ansible<span class=\"token punctuation\">-</span>inventory='hosts/act_user' \\\n          <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>ssh<span class=\"token punctuation\">-</span>config='/github/home/.ssh/config'\n\n<span class=\"token comment\"># todo: variable from vars_file</span></code></pre></div>\n<h2>Matirx</h2>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># Example</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> tests\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> develop <span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> master <span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">docker_image</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span> ubuntu18.04<span class=\"token punctuation\">,</span> ubuntu20.04 <span class=\"token punctuation\">]</span> <span class=\"token comment\"># &lt;- 指定したイメージで実行</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.docker_image <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">DOCKER_USER</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"vagrant\"</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> docker build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -f dockerfiles/${{ matrix.docker_image }}/Dockerfile . -t ${{ matrix.docker_image }}\n          docker run -itd --privileged --name ${{ matrix.docker_image }} ${{ matrix.docker_image }}\n          sleep 5</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Ansible\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          container_ip=$(docker inspect --format \"{{ .NetworkSettings.IPAddress }}\" ${{ matrix.docker_image }})\n          echo \"ssh :  ${{ env.DOCKER_USER }}@$container_ip\"\n          chmod 600 .ssh/ansible_rsa\n          ssh -o StrictHostKeyChecking=no ${{ env.DOCKER_USER }}@$container_ip -i .ssh/ansible_rsa \"cd  ~/ansible &amp;&amp; \\\n          pip3 install -r requirements.txt &amp;&amp; \\\n          source ~/.profile &amp;&amp; \\\n          ansible-lint site.yml &amp;&amp; \\\n          black &amp;&amp; \\\n          flake8 tests &amp;&amp; \\\n          ansible-playbook -i hosts/develop site.yml -l ${{ matrix.docker_image }}\"</span></code></pre></div>\n<h2>ACT ( Exec Github Actions on local )</h2>\n<p>Install for Linux , Mac</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> https://raw.githubusercontent.com/nektos/act/master/install.sh <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">bash</span></code></pre></div>\n<p>Ansible tasks</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token comment\"># tasks file for roles/act</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> check installed act\n  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> bash <span class=\"token punctuation\">-</span>lc \"act <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>version\"\n  <span class=\"token key atrule\">register</span><span class=\"token punctuation\">:</span> act_exists\n  <span class=\"token key atrule\">changed_when</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n  <span class=\"token key atrule\">ignore_errors</span><span class=\"token punctuation\">:</span> yes\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install act\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> yes\n  <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    bash -lc \"curl https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash\"</span>\n  <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> act_exists is failed</code></pre></div>","frontmatter":{"title":"Github Actions 基本","date":"December 14, 2020","post_modified":"December 14, 2020","description":"Github Actions, Act (GitHub Actions の local実行)","tags":["Linux","Docker","GitHub Actions"],"draft":false}},"previous":{"fields":{"slug":"/Infrastructure/Iac/ansible_letsencrypt/"},"frontmatter":{"title":"Ansible, Let's Encrypt"}},"next":{"fields":{"slug":"/BackEnd/php/laravel/laravel_middleware-_accesslog/"},"frontmatter":{"title":"laravel middleware で access履歴"}}},"pageContext":{"id":"7500472b-2e7a-5952-a48f-d109973b87e2","previousPostId":"955174d8-51ea-55a3-bf37-27747e60ed21","nextPostId":"436d0479-0cb7-5ac3-99cd-b24200a2a540","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","2772418575"]}