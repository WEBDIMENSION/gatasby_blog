{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/blog/Infrastructure/nginx/nginx_conf/",
    "result": {"data":{"site":{"siteMetadata":{"title":"おっさんWEBエンジニア奮闘記"}},"markdownRemark":{"id":"2a22ea94-3dff-5f0b-92d1-2cefb0fecbdf","excerpt":"Reverse Proxy Header Keep-Alive Redirect Cookie weight basckup server Connect to Min Conection counts server Hash #timeout cache SSL webSocket File upload size…","html":"<h2>Reverse Proxy</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Basic</span>\nhttp <span class=\"token punctuation\">{</span>\n  upstream  app1 <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10:8080<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11:80<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.12:8080<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    location / <span class=\"token punctuation\">{</span>\n      proxy_pass http://app1<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>Header</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#header</span>\nserver <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\"># hostname (upstream name)</span>\n  proxy_set_header Host                  <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\"># client IP Address \u001b$B$=$l$>$l$N%j%P!&lt;%9%W%m%-%7$G@hF,$KDI2C!#%+%s%^6h@Z$j\u001b(B</span>\n  proxy_set_header X-Forwarded-For       <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\"># \u001b$B&lt;u?.$7$?\u001b(BHost header</span>\n  proxy_set_header X-Forwarded-Host      <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\"># host name</span>\n  proxy_set_header X-Forwarded-Server    <span class=\"token variable\">$hostname</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\"># client IP Address</span>\n  proxy_set_header X-Real_IP             <span class=\"token variable\">$reomote_addr</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Keep-Alive</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># For client</span>\nserver <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">..</span>.\n  keepalive_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># For backend</span>\nhttp <span class=\"token punctuation\">{</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10:8080<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11:80<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.12:8080<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    location / <span class=\"token punctuation\">{</span>\n      proxy_http_verssion <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n      proxy_set_header Connection <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n      proxy_pass http://backend<span class=\"token punctuation\">;</span>\n\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Redirect</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\nhttp <span class=\"token punctuation\">{</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10:8080<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11:80<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.12:8080<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    server_name example.com<span class=\"token punctuation\">;</span>\n\n    location /one/ <span class=\"token punctuation\">{</span>\n      proxy_pass http://backend/two<span class=\"token punctuation\">;</span>\n      proxy_redirect http://backend/two http://example.com/one/<span class=\"token punctuation\">;</span> <span class=\"token comment\"># default</span>\n     <span class=\"token punctuation\">}</span>\n\n    location /two/ <span class=\"token punctuation\">{</span>\n      rewrite   ~/three/1 /three/2\n      proxy_pass http://backend/for/<span class=\"token punctuation\">;</span>\n      <span class=\"token comment\"># URL\u001b$B$r=q$-49$($?>l9g$OL@&lt;(E*$K$b$H$KLa$9\u001b(B</span>\n      proxy_redirect http://backend/four/2 http://example.com/three/1/<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>Cookie</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    server_name example.com<span class=\"token punctuation\">;</span>\n\n    location /one/ <span class=\"token punctuation\">{</span>\n      proxy_pass http://backend/two<span class=\"token punctuation\">;</span>\n      proxy_cookie_path  /two/  /one/\n      proxy_cookie_domain backened <span class=\"token variable\">$server_name</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>weight</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  upstream  backend <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10 <span class=\"token assign-left variable\">weight</span><span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11:weight<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.12<span class=\"token punctuation\">;</span>  <span class=\"token comment\">#default is weight=1</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>basckup server</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 192.168.1.10 \u001b$B$,\u001b(BDown\u001b$B$7$?>l9g$K\u001b(B 192.168.1.11\u001b$B$,\u001b(Bup</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11 backup<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Connect to Min Conection counts server</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  least_conn<span class=\"token punctuation\">;</span> <span class=\"token comment\">#minimum connection</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Hash</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\">#User-Agent</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">hash</span> <span class=\"token variable\">$http_user_agent</span>\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># path</span>\n<span class=\"token comment\"># consistent \u001b$B$O%5!&lt;%P$NBf?t$J$I$,JQ$o$C$?>l9g$K$bBP1~\u001b(B</span>\n  upstream  backend <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">hash</span> <span class=\"token variable\">$url</span> consistent\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">192.168</span>.1.11<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>#timeout</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">    location /one/ <span class=\"token punctuation\">{</span>\n      proxy_pass http://backend/two<span class=\"token punctuation\">;</span>\n      proxy_content_timeout   60s<span class=\"token punctuation\">;</span>\n      proxy_read_timeout   60s<span class=\"token punctuation\">;</span>\n      proxy_send_timeout   60s<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>cache</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">proxy_cache_path /var/cache/nginx/rproxy\n                <span class=\"token assign-left variable\">levels</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>:2 <span class=\"token assign-left variable\">keys_zone</span><span class=\"token operator\">=</span>proxy1:10m\n                <span class=\"token assign-left variable\">inactive</span><span class=\"token operator\">=</span>1d<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">#key_zone name:volume</span>\n\nhttp <span class=\"token punctuation\">{</span>\n  upstream  app1 <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    location / <span class=\"token punctuation\">{</span>\n      proxy_cache proxy1\n      <span class=\"token comment\"># Not use cashe</span>\n      proxy_chache_bypass <span class=\"token variable\">$http_authorization</span> <span class=\"token variable\">$jttp_cookie</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\"># Not use cashe</span>\n      proxy_no_chache <span class=\"token variable\">$http_authorization</span> <span class=\"token variable\">$jttp_cookie</span><span class=\"token punctuation\">;</span>\n      proxy_pass http://app1<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>SSL</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\nhttp <span class=\"token punctuation\">{</span>\n  upstream  app1 <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span>\n    ssl_certificate /etc/<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>./server.crt\n    ssl_certificate_key /etc/<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>/server.key\n    location / <span class=\"token punctuation\">{</span>\n      proxy_cache proxy1\n      <span class=\"token comment\"># Not use cashe</span>\n      proxy_chache_bypass <span class=\"token variable\">$http_authorization</span> <span class=\"token variable\">$jttp_cookie</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\"># Not use cashe</span>\n      proxy_no_chache <span class=\"token variable\">$http_authorization</span> <span class=\"token variable\">$jttp_cookie</span><span class=\"token punctuation\">;</span>\n      proxy_pass http://app1<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># If backend use SSL</span>\nhttp <span class=\"token punctuation\">{</span>\n  upstream  app1 <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10:443<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    location / <span class=\"token punctuation\">{</span>\n      proxy_no_chache <span class=\"token variable\">$http_authorization</span> <span class=\"token variable\">$jttp_cookie</span><span class=\"token punctuation\">;</span>\n      proxy_pass http://app1<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n</code></pre></div>\n<h2>webSocket</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">http <span class=\"token punctuation\">{</span>\n  upstream  app1 <span class=\"token punctuation\">{</span>\n    server <span class=\"token number\">192.168</span>.1.10:443<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  server <span class=\"token punctuation\">{</span>\n    location /chat/ <span class=\"token punctuation\">{</span>\n      proxy_pass http://app1<span class=\"token punctuation\">;</span>\n      proxy_http_verssion <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n      proxy_set_header Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n      proxy_set_header Upgrade Connection <span class=\"token variable\">$connection_upgrade</span><span class=\"token punctuation\">;</span>\n      proxy_read_timeout 1h<span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>File upload size &#x26; Buffer</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">\n  server <span class=\"token punctuation\">{</span>\n    location /chat/ <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">..</span>.\n    cliecnt_max_body_size 100m<span class=\"token punctuation\">;</span> <span class=\"token comment\"># Max 100MB</span>\n    client_body_buffer_size 1m<span class=\"token punctuation\">;</span> <span class=\"token comment\"># Max 1MB on memory  0 is no limit</span>\n    client_body_temp_path /var/tmp/nginx_temp <span class=\"token number\">1</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\"># buffer on file when size over</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">#No buffering</span>\n  server <span class=\"token punctuation\">{</span>\n    location /chat/ <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">..</span>.\n    proxy_reqest_buffering off<span class=\"token punctuation\">;</span>\n    proxy_http_verssion <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># when use chanck</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2>For maintenance</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">geo <span class=\"token variable\">$maintenance</span><span class=\"token punctuation\">{</span>\n  default         <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token number\">192.168</span>.1.0/24  <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n  server <span class=\"token punctuation\">{</span>\n\n  error_page <span class=\"token number\">503</span> /503.html<span class=\"token punctuation\">;</span>\n\n  location <span class=\"token operator\">=</span> /503.html<span class=\"token punctuation\">{</span>\n      root /path/to/eroorpage<span class=\"token punctuation\">;</span>\n      internal\n  <span class=\"token punctuation\">}</span>\n\n  location /image/ <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">alias</span> /path/to/image/<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  location /css/ <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">alias</span> /path/to/css/<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  location / <span class=\"token punctuation\">{</span>\n    if<span class=\"token punctuation\">(</span><span class=\"token variable\">$maintenace</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">503</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    proxy_pass <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Nginx conf","date":"February 23, 2022","post_modified":"February 23, 2022","description":"Nginx 設置ファイル コピペ用","tags":["Nginx"],"draft":false}},"previous":{"fields":{"slug":"/Infrastructure/monitoring/"},"frontmatter":{"title":"サーバーモニタリングツール"}},"next":{"fields":{"slug":"/Tools/makefile/makefile_basic/"},"frontmatter":{"title":"makefile"}}},"pageContext":{"id":"2a22ea94-3dff-5f0b-92d1-2cefb0fecbdf","previousPostId":"7ee22331-607a-51d2-b5c5-dfea2ede27a5","nextPostId":"92a52084-302c-51b4-b176-815183e32cd4","draft":false}},
    "staticQueryHashes": ["1126706167","1176493165","1188992244","1314910092","2772418575"]}